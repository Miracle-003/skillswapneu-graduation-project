datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model UserProfile {
  userId            String                 @id @map("user_id") @db.Uuid
  user              AppUser                @relation(fields: [userId], references: [id], onDelete: Cascade)
  fullName          String                 @map("full_name")
  major             String?
  year              String?
  bio               String?
  learningStyle     String?                @map("learning_style")
  studyPreference   String?                @map("study_preference")
  interests         String[]               @default([])
  createdAt         DateTime               @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime               @updatedAt @map("updated_at") @db.Timestamptz(6)
  connectionsAs1    Connection[]           @relation("connections_user1")
  connectionsAs2    Connection[]           @relation("connections_user2")
  messagesRecv      Message[]              @relation("messages_receiver")
  messagesSent      Message[]              @relation("messages_sender")
  submissions       PeerReviewSubmission[]
  reviewsGiven      PeerReview[]           @relation("reviews_reviewer")
  userAchievements  UserAchievement[]
  pointsHistory     PointsHistory[]

  @@map("user_profiles")
}

model Connection {
  id        String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId1   String      @map("user_id_1") @db.Uuid
  userId2   String      @map("user_id_2") @db.Uuid
  status    String      @default("pending")
  createdAt DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  user1     UserProfile @relation("connections_user1", fields: [userId1], references: [userId], onDelete: Cascade)
  user2     UserProfile @relation("connections_user2", fields: [userId2], references: [userId], onDelete: Cascade)

  @@unique([userId1, userId2])
  @@map("connections")
}

model Message {
  id         String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  senderId   String      @map("sender_id") @db.Uuid
  receiverId String      @map("receiver_id") @db.Uuid
  content    String
  createdAt  DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  receiver   UserProfile @relation("messages_receiver", fields: [receiverId], references: [userId], onDelete: Cascade)
  sender     UserProfile @relation("messages_sender", fields: [senderId], references: [userId], onDelete: Cascade)

  @@map("messages")
}

model PeerReviewSubmission {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String       @map("user_id") @db.Uuid
  title       String
  description String
  course      String
  fileUrl     String       @map("file_url")
  status      String       @default("pending")
  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  author      UserProfile  @relation(fields: [userId], references: [userId], onDelete: Cascade)
  reviews     PeerReview[]

  @@map("peer_review_submissions")
}

model PeerReview {
  id           String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  submissionId String               @map("submission_id") @db.Uuid
  reviewerId   String               @map("reviewer_id") @db.Uuid
  rating       Int
  feedback     String?
  createdAt    DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  reviewer     UserProfile          @relation("reviews_reviewer", fields: [reviewerId], references: [userId], onDelete: Cascade)
  submission   PeerReviewSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([submissionId, reviewerId])
  @@map("peer_reviews")
}

model Achievement {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @unique
  description String
  icon        String?
  category    String
  points      Int      @default(0)
  requirement Json
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String      @map("user_id") @db.Uuid
  achievementId String      @map("achievement_id") @db.Uuid
  unlockedAt    DateTime    @default(now()) @map("unlocked_at") @db.Timestamptz(6)
  progress      Json        @default("{}")

  user        UserProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

model PointsHistory {
  id            String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String      @map("user_id") @db.Uuid
  points        Int
  reason        String
  referenceType String?     @map("reference_type")
  referenceId   String?     @map("reference_id")
  createdAt     DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)

  user UserProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("points_history")
}

model Match {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId1            String   @map("user_id_1") @db.Uuid
  userId2            String   @map("user_id_2") @db.Uuid
  compatibilityScore Float    @map("compatibility_score")
  status             String   @default("pending")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("matches")
}

model UserAccount {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String?
  createdAt DateTime? @map("created_at") @db.Timestamptz(6)

  @@map("user_accounts")
}

model AppUser {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email             String    @unique
  passwordHash      String    @map("password_hash")
  avatarUrl         String?   @map("avatar_url")
  emailVerifiedAt   DateTime? @map("email_verified_at") @db.Timestamptz(6)
  role              Role      @default(user)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  verificationTokens EmailVerificationToken[]
  profile           UserProfile?

  @@map("app_users")
}

model EmailVerificationToken {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tokenId    String   @unique @map("token_id")
  secretHash String   @map("secret_hash")
  userId     String   @map("user_id") @db.Uuid
  email      String
  linkUrl    String   @map("link_url")
  expiresAt  DateTime @map("expires_at") @db.Timestamptz(6)
  consumedAt DateTime?@map("consumed_at") @db.Timestamptz(6)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user AppUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_verification_tokens")
}

enum Role {
  user
  admin
}
